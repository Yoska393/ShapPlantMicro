---
title: "63_CheckCoefficient"
output: html_document
date: "2024-01-29"
---



required packages
```{r, message =F}
require(BGLR)
require(here)
require(ggplot2)
require(reshape2)
require(gridExtra)
library(readr)
library(stringr)
library(ggsci)
library(RAINBOWR)
library(lubridate)
library(foreach)
library(future)
library(doFuture)
library(doRNG)
library(tictoc)
library(doSNOW)
library(purrr)
source("Script/MyFunctions.R")
library(vegan)
library(VARshrink)
library(ggplot2)
library(glmnet)
library(lars)
require(ranger)
require(ggrepel)
require(tidyverse)
library(MASS)
library(pander)
getwd()
```

seed
```{r, message =F}
# save or read the seed
seedIndCsv <-  here("out","seedInd.csv")
if (file.exists(seedIndCsv)) {
  seedInd <- read.csv(seedIndCsv, row.names = 1, header = T)
  seedInd <- c(as.matrix(seedInd))
} else {
  seedInd <- sample(1:500, 10, replace = F)
  write.csv(x = seedInd, file =  here("out","seedInd.csv"))
}
```

read phenotypic data
```{r}
pheno18 <- read.csv(here("2018", "shoot_blup_all_2018.csv"), row.names = 1)
pheno19 <- read.csv(here("2019", "shoot_blup_all_2019.csv"), row.names = 1)
pheno20 <- read.csv(here("2020", "shoot_blup_all_2020.csv"), row.names = 1)

plot18<-rownames(pheno18)
plot19<-rownames(pheno19)
plot20<-rownames(pheno20)

var18<-pheno18$var.id
var19<-pheno19$var.id
var20<-pheno20$var.id
```

read genomic relationship matrix data
```{r}
grm <- readRDS(here("data", "grm_2.rds"))
head(grm)[,1:3]
```

read genomic data
```{r}

bm<- read.csv(here("data/genome","genoMarker_LD0.001_SNP3078.csv"),row.names = 1)

head(bm)[,1:3]

genome <- as.matrix(bm)
dim(genome)
```


read metabolomic data
```{r}
met<- read.csv(here("2019","2019_Tottori_Jul_RootMetabolome_X.csv"))
rownames(met) <- paste0(substr(as.matrix(met[7]),1,2),".",sprintf("%03d",as.matrix(met[8])))
met19 <- met[,10:ncol(met)]
colnames(met19)<- sub("M","X",colnames(met19))

met <- read.csv(here("2020", "2020_Tottori_Main_RootMetabolome.csv"))
rownames(met) <- paste0(substr(as.matrix(met[7]),1,2),".",sprintf("%03d",as.matrix(met[8])))
met20 <- met[,10:ncol(met)]

s_c <- colnames(met19) %in% colnames(met20)
met19<- met19[,s_c]
s_c <- colnames(met20) %in% colnames(met19)
met20<- met20[,s_c]
table(colnames(met20) == colnames(met19))

dim(met19)
dim(met20)
```

read met index

```{r}
metind<- read.csv(here("data","Metabolome_index.csv"))
metindex<- matrix(metind[,2],583,1)
rownames(metindex)<- metind[1:583,1]
```


read microbiome rarificated data
```{r}
com <- read.table(here("2018", "table-from-biom-7-2018-after.txt"), row.names = 1)
rownames(com) <- gsub(";",".",rownames(com))
com18<- com
colnames(com18) <- cbind(plot18[201:400],plot18[601:800])

com <- read.csv(here("2019", "table-from-biom-7.csv"), row.names = 1)
rownames(com) <- gsub(";",".",rownames(com))
com19<- com

#comriken <- read.csv(here("2020", "table-from-biom-7-2020-after.csv"))
com <- read.csv(here("2020", "2020_Tottori_Main_Microbiome_Ratio.csv"))
rownames(com) <- paste0(substr(as.matrix(com[7]),1,2),".",sprintf("%03d",as.matrix(com[8])))
com <- com[,10:ncol(com)]
com20 <- t(com)

#s_c <- rownames(com19) %in% rownames(com20)
#com19<- com19[s_c,]
#s_c <- rownames(com20) %in% rownames(com19)
#com20<- com20[s_c,]

s_c <- (rownames(com19) %in% rownames(com20)) & (rownames(com19) %in% rownames(com18))
com19<- com19[s_c,]
s_c <- rownames(com20) %in% rownames(com19)
com20<- com20[s_c,]
s_c <- rownames(com18) %in% rownames(com20)
com18<- com18[s_c,]

dim(com18)
dim(com19)
dim(com20)
```

### Drought

```{r}
CD ="W4"
```



read predmet
```{r}

if (CD == "W4"){
  print(CD)
  cd<- "Drought"
  predmet20f19 <- read.csv(here("out", "20f19_predmet_G_blup_OneOut.csv"), row.names = 1)
  predmet19f20 <- read.csv(here("out", "19f20_predmet_G_blup_OneOut.csv"), row.names = 1)
  
  predmet19 <- read.csv(here("out", "19f19_predmet_G_blup_OneOut.csv"), row.names = 1)
  predmet20 <- read.csv(here("out", "20f20_predmet_G_blup_OneOut.csv"), row.names = 1)
  
  RF <- readRDS(here("out", "19f19_predMet_RF_OneOut_W4.rds"))
  predmet19RF<-RF[["G"]]
  
  RF2 <- readRDS(here("out", "19f20_predMet_RF_OneOut_W4.rds"))
  predmet19f20RF<-RF2[["G"]]

  } else if (CD == "W1"){
  print(CD)
  cd<- "Control"
  predmet20f19 <- read.csv(here("out", "20f19_predmet_G_blup_OneOut_c.csv"), row.names = 1)
  predmet19f20 <- read.csv(here("out", "19f20_predmet_G_blup_OneOut_c.csv"), row.names = 1)
  
  predmet19 <- read.csv(here("out", "19f19_predmet_G_blup_OneOut_c.csv"), row.names = 1)
  predmet20 <- read.csv(here("out", "20f20_predmet_G_blup_OneOut_c.csv"), row.names = 1)
  
  RF <- readRDS(here("out", "19f19_predMet_RF_OneOut_W1.rds"))
  predmet19RF<-RF[["G"]]
  
  RF2 <- readRDS(here("out", "19f20_predMet_RF_OneOut_W1.rds"))
  predmet19f20RF<-RF2[["G"]]
  
  } else {
  print("error")
  }

dim(predmet19)
#RF <- readRDS(here("out", "19f19_predMet_RF_OneOut_W4snp.rds"))
#predmet19RFsnp<-RF[["G+Micro"]] 

```



select the lines which has pheno, grm, met, micro data in 2019 and 2020
```{r}
selector.grm1 <- pheno18$var.id %in% rownames(grm)
selector.com1 <-rownames(pheno18) %in% colnames(com18)

selector.grm2 <- pheno19$var.id %in% rownames(grm)
selector.com2 <-rownames(pheno19) %in% colnames(com19)

selector.grm3 <- pheno20$var.id %in% rownames(grm)
selector.com3 <-rownames(pheno20) %in% colnames(com20)


pl<- list(pheno18,pheno19,pheno20)
pl.sel<- list()

for (i in 2:3){
pheno<- pl[[i]]

if (i==1) {
  selector.grm <- selector.grm1
  selector.com <- selector.com1
}

else if (i==2) {
  selector.grm <- selector.grm2
  selector.com <- selector.com2
}

else if (i==3) {
  selector.grm <- selector.grm3
  selector.com <- selector.com3
}


pheno.sel <- pheno[selector.grm & selector.com, ]
#head(pheno.sel)
print(dim(pheno.sel))

selector.cd <- substr(rownames(pheno.sel), 1, 2) == CD 
pheno.sel.cd <- pheno.sel[selector.cd, ]
dim(pheno.sel.cd)

plot.id <- rownames(pheno.sel.cd)
rownames(pheno.sel.cd)<-pheno.sel.cd$var.id
pheno.sel.cd$var.id <- plot.id
colnames(pheno.sel.cd)[1]<- "plot.id"
sg <- rownames(grm) %in% rownames(pheno.sel.cd)
gv<-rownames(grm[sg,sg])
pheno.sel.cd<- pheno.sel.cd[gv,]
print(dim(pheno.sel.cd))
pl.sel[[i]]<- pheno.sel.cd
}

#psc18<-  pl.sel[[1]]
psc19<-  pl.sel[[2]] 
psc20<-  pl.sel[[3]]



s_p <- rownames(psc19) %in% rownames(psc20)
psc19<- psc19[s_p,]
s_p <- rownames(psc20) %in% rownames(psc19)
psc20<- psc20[s_p,]

#s_p <- colnames(psc19) %in% colnames(psc20)
#psc19<- psc19[,s_p]
#s_p <- colnames(psc20) %in% colnames(psc19)
#psc20<- psc20[,s_p]

table(rownames(psc19) == rownames(psc20))

```



2019 
```{r}
var.id <- rownames(psc19)
grm.cd <- grm[var.id, var.id]
plot.id  <- psc19$plot.id
com19.cd <- t(com19[, plot.id])
com19.cd <- scale(com19.cd[, apply(com19.cd, 2, sd) > 0])
#met19ns.cd <- met19[plot.id, ]
met19.cd <- scale(met19[plot.id, ])
#predmet19ns<-predmet19
predmet19<-scale(predmet19)
genome.cd<- genome[var.id,]
predmet19RF<-scale(predmet19RF)
predmet19f20RF<-scale(predmet19f20RF)
```


2020
```{r, message =F}
var.id <- rownames(psc20)
grm.cd <- grm[var.id, var.id]
plot.id  <- psc20$plot.id
com20.cd <- t(com20[, plot.id])
com20.cd <- scale(com20.cd[, apply(com20.cd, 2, sd) > 0])
#met20ns.cd <- met20[plot.id, ]
met20.cd <- scale(met20[plot.id, ])
#predmetns20<-predmet20
predmet20<-scale(predmet20)
#predmetns20f19<-predmet20f19
predmet20f19<-scale(predmet20f19)
predmet19f20<-scale(predmet19f20)
#genome.cd<- genome[var.id,]
```


Integrate + RM
```{r, message =F}
psc <- rbind(psc19,psc19)

s_c <- colnames(com19.cd) %in% colnames(com20.cd)
com19.cd<- com19.cd[,s_c]
s_c <- colnames(com20.cd) %in% colnames(com19.cd)
com20.cd<- com20.cd[,s_c]

s_c <- colnames(com19.cd) %in% colnames(com20.cd)
com19.cd<- com19.cd[,s_c]
s_c <- colnames(com20.cd) %in% colnames(com19.cd)
com20.cd<- com20.cd[,s_c]

mrm19.cd <- tcrossprod(com19.cd) / ncol(com19.cd)
mrm20.cd <- tcrossprod(com20.cd) / ncol(com20.cd)

com.cd<- rbind(com19.cd,com20.cd)
rownames(com.cd)<-rownames(psc)
mrm.cd <- tcrossprod(com.cd) / ncol(com.cd)

metrm19.cd <- tcrossprod(met19.cd) / ncol(met19.cd)
metrm20.cd <- tcrossprod(met20.cd) / ncol(met20.cd)

metPrm19.cd <- tcrossprod(predmet19) / ncol(predmet19)
metPrm20.cd <- tcrossprod(predmet20) / ncol(predmet20)

metPrm20f19.cd <- tcrossprod(predmet20f19) / ncol(predmet20f19)
metPrm19f20.cd <- tcrossprod(predmet19f20) / ncol(predmet19f20)

metPrm19RF.cd <- tcrossprod(predmet19RF) / ncol(predmet19RF)
metPrm19f20RF.cd <- tcrossprod(predmet19f20RF) / ncol(predmet19f20RF)

#metns.cd <- rbind(met19ns.cd,met20ns.cd)
met.cd<- rbind(met19.cd,met20.cd)
rownames(met.cd)<-rownames(psc)
metrm.cd <- tcrossprod(met.cd) / ncol(met.cd)
```

```{R}
comn<-  paste0(rep("OTU_",ncol(com19.cd)),1:ncol(com19.cd))
comnameL <-colnames(com19.cd)
colnames(com19.cd)<- comn
```


###Yield 2019model

```{r, message =F, include=TRUE,eval=TRUE}
K1 <- grm.cd
K2 <- mrm19.cd
K3 <- metrm19.cd
K8 <- metPrm19.cd
K9 <- metPrm19f20.cd
#K10 <- RDA_M
K11 <- metPrm19RF.cd
K12 <- metPrm19f20RF.cd

Z <- design.Z(pheno.labels = rownames(grm.cd),geno.names = rownames(grm.cd))

KZ1<- list(A= list(K = K1, Z = Z))
KZ2<- list(A= list(K = K2, Z = Z))
KZ3<- list(A= list(K = K3, Z = Z))
KZ8<- list(A= list(K = K8, Z = Z))
KZ9<- list(A= list(K = K9, Z = Z))
KZ11<- list(A= list(K = K11, Z = Z))
KZ12<- list(A= list(K = K12, Z = Z))

KZ1_2<- list(A= list(K = K1, Z = Z),B= list(K = K2, Z = Z))

KZ1_2_8<- list(A= list(K = K1, Z = Z),B= list(K = K2, Z = Z),C= list(K = K8, Z = Z))
KZ1_2_9<- list(A= list(K = K1, Z = Z),B= list(K = K2, Z = Z),C= list(K = K9, Z = Z))
KZ1_2_11<- list(A= list(K = K1, Z = Z),B= list(K = K2, Z = Z),C= list(K = K11, Z = Z))
KZ1_2_12<- list(A= list(K = K1, Z = Z),B= list(K = K2, Z = Z),C= list(K = K12, Z = Z))
KZ1_2_3<- list(A= list(K = K1, Z = Z),B= list(K = K2, Z = Z),C= list(K = K3, Z = Z))


ZETAlist <- list(KZ1_2_8,KZ1_2_9,KZ1_2_11,KZ1_2_12,KZ1_2_3)
names(ZETAlist) <- c("KZ1_2_8","KZ1_2_9","KZ1_2_11","KZ1_2_12","KZ1_2_3")
names<- names(ZETAlist)

```

```
ZETAlist <- list(KZ2)
names(ZETAlist) <- c("KZ2")
names<- names(ZETAlist)

```


```{R, message =F, include=TRUE,eval=TRUE}
y <- psc19

zl = ZETAlist[[1]]
  
  ZETA <- zl
  X0 <- NULL
  i <- 2
    resEM3 <- EM3.cpp(y = y[,i],
                        X0 = X0, n.core = 1, 
                        ZETA = ZETA)


```


ModelRun
```{R, message =F, include=TRUE,eval=TRUE}
y <- psc19

resblup<- foreach(zl = ZETAlist) %do% {
  print("fine")
  ZETA <- zl
  X0 <- NULL
  
  result_matrix <- matrix(nrow = 3*nrow(y), ncol = 0)
  for (i in 2:ncol(y)){
    resEM3 <- EM3.cpp(y = y[,i],
                        X0 = X0, n.core = 1, 
                        ZETA = ZETA)
    result_matrix <- cbind(result_matrix, resEM3[["u.each"]])
  }
  return(result_matrix)
  }
  
names(resblup)<- names(ZETAlist)
```



```{r}
bget <- function(Xp,K,Up) {
  XXt <- K * ncol(Xp)
  B <- t(Xp) %*% ginv(XXt) %*% Up
  return(B)
}

Up<- resblup[["KZ1_2_3"]]

Up1<-Up[1:nrow(y),]
Up2<-Up[nrow(y)+1:nrow(y)*2,]
Up3<-Up[(nrow(y)*2+1): (nrow(y)*3),]

#Xp1<-genome.cd
Xp1<-grm.cd
Xp2<-com19.cd
Xp3<-met19.cd
Xp8<-predmet19RF

B1<-bget(Xp1,K1,Up1) 
B2<-bget(Xp2,K2,Up2) 
B3<-bget(met19.cd,K3,Up2) 
B8<-bget(predmet19,K8,Up3) 
B11<-bget(Xp8,K11,Up3) 

i=1

plot(Up2[,i], Xp3 %*% B3[,i])
```


```{r}
#Ball<-rbind(B1,B2,B3)
Ball<-rbind(B1,B2,B11)
```


normalize
```{r}
coef<- t(Ball)
rownames(coef)<- colnames(y)[2:ncol(y)]

#coef<-coef[-c(5,6,7),]
barplot(coef[1,])
imp.norm <- diag(1 / apply(coef, 1, sum)) %*% coef
#scale
barplot(imp.norm[3,])
rownames(imp.norm) <- rownames(coef)
```

devide
```
imp.g <- imp.norm[, 1:ncol(genome.cd)]
imp.m <- imp.norm[, (ncol(genome.cd)+1):((ncol(genome.cd))+(ncol(com19.cd)))]
imp.met <- imp.norm[, ((ncol(genome.cd))+(ncol(com19.cd))+1):(ncol(imp.norm))]
```

```{r}
imp.g <- imp.norm[, 1:ncol(grm.cd)]
imp.m <- imp.norm[, (ncol(grm.cd)+1):((ncol(grm.cd))+(ncol(com19.cd)))]
imp.met <- imp.norm[, ((ncol(grm.cd))+(ncol(com19.cd))+1):(ncol(imp.norm))]
barplot(cbind(imp.g, imp.met, imp.m))
```

```{r}
imp.g <- t(apply(imp.g, 1, function(row) row / abs(median(row))))
imp.m <- t(apply(imp.m, 1, function(row) row / abs(median(row))))
imp.met <- t(apply(imp.met, 1, function(row) row / abs(median(row))))

barplot(cbind(imp.g, imp.met, imp.m))
```


# Histgram and Heatmap

```{r}
boxplot(imp.g)
heatmap(imp.g)
heatmap(imp.norm)
```

```{r}
hist(apply(imp.m, 2, sum),main="Sum of coef for each OTU",breaks=100,xlab = "coef of OTU",ylab = "The Number of OTU")
```


##Micro
```{r,include==FALSE}
res <- svd(imp.m)
contr <- res$d / sum(res$d)

colnames(imp.m) <- paste0("OTU", 1:ncol(imp.m))
rownames(res$u) <- rownames(imp.m)
rownames(res$v) <- colnames(imp.m)
ud <- res$u %*% diag(sqrt(res$d))
vd <- res$v %*% diag(sqrt(res$d))

df.u <- data.frame(ud[, 1:2] , Type = "Yield", Name = rownames(ud))
df.v <- data.frame(vd[, 1:2], Type = "Microbiome", Name = rownames(vd))
df <- data.frame(rbind(df.u, df.v))
colnames(df)[1:2] <- colnames(df.u)[1:2] <- colnames(df.v)[1:2] <- paste0("LF", 1:2)
head(df)

g <- ggplot(df, aes(x = LF1, y = LF2, color = Type))
g <- g + geom_point(alpha=1,shape=21)
g <- g + geom_label_repel(aes(label = Name),
                  box.padding   = 0.5, 
                  point.padding = 0.35,
                  segment.color = 'grey50',
                  max.overlaps = 30,
                  cex=2.5,alpha=0.8,show.legend= FALSE )

g<- g + scale_color_manual(values = c("#00AFBB","darkgreen"))
g
```


list of OTU
```{r}
otu <- comnameL
names(otu) <- colnames(imp.m)
otu[c("OTU167", "OTU438", "OTU555")]

metindex[c("X100039","X200087","X00863"),]
```

## Genome

```{r}
res <- svd(imp.g)
contr <- res$d / sum(res$d)


rownames(res$u) <- rownames(imp.g)
rownames(res$v) <- colnames(imp.g)

ud <- res$u %*% diag(sqrt(res$d))
vd <- res$v %*% diag(sqrt(res$d))

df.u <- data.frame(ud[, 1:2] , Type = "Yield", Name = rownames(ud))
df.v <- data.frame(vd[, 1:2], Type = "Genotype", Name = rownames(vd))
df <- data.frame(rbind(df.u, df.v))
colnames(df)[1:2] <- colnames(df.u)[1:2] <- colnames(df.v)[1:2] <- paste0("LF", 1:2)
head(df)

g <- ggplot(df, aes(x = LF1, y = LF2, color = Type))
g <- g + geom_point(alpha=1,shape=21)
g <- g + geom_label_repel(aes(label = Name),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50',
                  max.overlaps = 60,
                  cex=2.5,alpha=0.8,show.legend= FALSE )
g<- g + scale_color_manual(values = c( "#FC4E07","darkgreen"))
g
```


## Met
```{r}
res <- svd(imp.met)
contr <- res$d / sum(res$d)

rownames(res$u) <- rownames(imp.met)
rownames(res$v) <- colnames(imp.met)

ud <- res$u %*% diag(sqrt(res$d))
vd <- res$v %*% diag(sqrt(res$d))

df.u <- data.frame(ud[, 1:2] , Type = "Yield", Name = rownames(ud))
df.v <- data.frame(vd[, 1:2], Type = "Metabolome", Name = rownames(vd))
df <- data.frame(rbind(df.u, df.v))
colnames(df)[1:2] <- colnames(df.u)[1:2] <- colnames(df.v)[1:2] <- paste0("LF", 1:2)
head(df)

g <- ggplot(df, aes(x = LF1, y = LF2, color = Type))
g <- g + geom_point(alpha=1,shape=21)
g <- g + geom_label_repel(aes(label = Name),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50',
                  max.overlaps = 60,
                  cex=2.5,alpha=0.8,show.legend= FALSE )
g<- g + scale_color_manual(values = c( "#E7B800","darkgreen"))
g
```

## Micro and Met and genome

```{r}
imp.gm <- cbind(imp.g, imp.met, imp.m)
res <- svd(imp.gm)
contr <- res$d / sum(res$d)


rownames(res$u) <- rownames(imp.gm)
rownames(res$v) <- colnames(imp.gm)

ud <- res$u %*% diag(sqrt(res$d))
vd <- res$v %*% diag(sqrt(res$d))

df.u <- data.frame(ud[, 1:2] , Type = "Yield", Name = rownames(ud))

type <- rep("Metabolome", nrow(vd))
type[1:ncol(grm.cd)] <- "Genotype"
type[substr(rownames(vd), 1, 3) == "OTU"] <- "Microbiome"
df.v <- data.frame(vd[, 1:2], Type = type, Name = rownames(vd))
df <- data.frame(rbind(df.u, df.v))

colnames(df)[1:2] <- colnames(df.u)[1:2] <- colnames(df.v)[1:2] <- paste0("LF", 1:2)

head(df)

g <- ggplot(df, aes(x = LF1, y = LF2, color = Type))
g <- g + geom_point(shape = 21,alpha=1) 
g <- g + geom_label_repel(aes(label = Name),
                  box.padding   = 0.2, 
                  point.padding = 0.5,
                  segment.color = 'grey50',
                  max.overlaps = 40,
                  cex=2,alpha=0.9,show.legend= FALSE )
g<- g + scale_color_manual(values = c( "#FC4E07","#E7B800","#00AFBB","darkgreen"))
g


```

```{r}
comn<-  paste0(rep("OTU_",ncol(com19.cd)),1:ncol(com19.cd))
comnameL <-colnames(com19.cd)
colnames(com19.cd)<- comn


```


```{r}

```

