
SHAP interaction

```{r}
require(here)
require(ranger)
library(igraph)
library(ggraph)
library(dplyr)
library(reticulate)
library(tidyverse)

extract_genus <- function(tax_str, rowname) {
  # Extract genus: pattern "g__XXXX"
  genus_match <- regmatches(tax_str, regexpr("g__[^;]+", tax_str))
  
  # Remove "g__" if found
  if (length(genus_match) > 0) {
    genus <- gsub("g__", "", genus_match)
  } else {
    genus <- NA
  }
  
  # Return rowname if genus is NA, empty, or 'uncultured'
  if (is.na(genus) || genus == "" || tolower(genus) == "uncultured") {
    return(rowname)
  } else {
    return(genus)
  }
}


get_X_selected <- function(condition){
  if (condition == "Drought") {
    Data <- readRDS(here("data/SoyData_Drought2.RDS"))
  } else if (condition == "Control") {
    Data <- readRDS(here("data/SoyData_Control2.RDS"))
  } else {
    stop("Unknown condition")
  }

  genome <- scale(Data$genome)
  met.cd <- scale(Data$met)
  mic.cd <- scale(Data$mic)
  X_all <- cbind(genome, mic.cd, met.cd)

  # imp_common_cols
  selected_columns <- intersect(imp_common_cols, colnames(X_all))
  X_selected <- X_all[, selected_columns, drop = FALSE]
  return(X_selected)
}
get_label <- function(name) {
  if (str_starts(name, "X")) {
    idx <- suppressWarnings(as.numeric(str_remove(name, "X")))
    if (!is.na(idx) && idx %in% 1:nrow(mm)) {
      out_label <- mm[idx, 1]
    } else {
      out_label <- NA
    }
  } else if (str_starts(name, "B")) {
    idx <- suppressWarnings(as.numeric(str_remove(name, "B")))
    if (!is.na(idx) && idx %in% 1:length(micro_labels_genus)) {
      out_label <- micro_labels_genus[idx]
    } else {
      out_label <- NA
    }
  } else {
    out_label <- name
  }

  if (!is.na(out_label)) {
    out_label <- substr(out_label, 1, 60)
  }

  return(out_label)
}


```


```{r}
# 1. importance files
imp_drought <- readRDS(here("out", "imp_RF2_d.RDS"))
imp_control <- readRDS(here("out", "imp_RF2_c.RDS"))


# 2. threshohold 0.001 for each condition
imp_d_cols <- colnames(imp_drought)[colSums(imp_drought) >= 0.001]
imp_c_cols <- colnames(imp_control)[colSums(imp_control) >= 0.001]

# 3.union
imp_common_cols <- union(imp_d_cols, imp_c_cols)

# 4. X_selected for each condition
X_selected_drought <- get_X_selected("Drought")
X_selected_control <- get_X_selected("Control")

# 5. common feature
common_features <- intersect(colnames(X_selected_drought), colnames(X_selected_control))

X_selected_drought <- X_selected_drought[, common_features, drop = FALSE]
X_selected_control <- X_selected_control[, common_features, drop = FALSE]

# 結果表示
cat("Common traits:", length(common_features), "\n")
cat("X_selected_drought dimension", dim(X_selected_drought), "\n")
cat("X_selected_control dimension", dim(X_selected_control), "\n")
```


```{r}
set.seed(123)

# Combine and scale feature sets
cd<-"Control" 
#cd<-"Drought" 

if (cd == "Drought") {
  X <- X_selected_drought
  Data <- readRDS(here("data/SoyData_Drought2.RDS"))
} else if (cd == "Control") {
  X <- X_selected_control
  Data <- readRDS(here("data/SoyData_Control2.RDS"))
} else {
  stop("Unknown condition")
}

genome<-Data$genome
grm.cd<-Data$grm
met.cd<-Data$met
mic.cd<-Data$mic

psc19<-Data$pheno
microname<-Data$microname
metname<-Data$metname
cd<-Data$cd

genome<- scale(genome)
met.cd<-scale(met.cd)
mic.cd <- scale(mic.cd)
psc19 <- scale(psc19)
mm<-matrix(metname,length(metname),1)
rownames(mm)<-  paste0("X", 1:length(metname))

cm<-matrix(microname,length(microname),1)
rownames(cm)<-  paste0("B", 1:length(microname))

micro_labels_genus <- mapply(extract_genus, cm[,1], rownames(cm))

im001<-X

# Convert to be usable in Python
assign("im001", im001, envir = .GlobalEnv)
assign("psc19", psc19, envir = .GlobalEnv)

```


```{python,eval=F}
import shap
import numpy as np
import pandas as pd
import xgboost
import matplotlib.pyplot as plt
import random
```


```{python,eval=F}
# Create data
X = r.im001
Y = r.psc19[:, 0]

print(X.shape)
print(Y.shape)

```




```{python,eval=F}
# Build model
seed =123
np.random.seed(seed)
random.seed(seed)

model = xgboost.XGBRegressor(random_state=seed,n_estimators=100,max_depth=6,learning_rate=0.3)
model.fit(X, Y)

# Calculate SHAP
explainer = shap.TreeExplainer(model)
shap_interaction_values = explainer.shap_interaction_values(X)

# Interaction matrix
interaction_matrix = pd.DataFrame(shap_interaction_values.mean(axis=0))

interaction_matrix
```


```{python,eval=F}

# If interaction_matrix is a DataFrame, flatten all values and draw a histogram
interaction_matrix_values = interaction_matrix.values.flatten()

# # Plot histogram
# plt.hist(interaction_matrix_values, bins=30, edgecolor='black')
# plt.title('Histogram of SHAP Interaction Values')
# plt.xlabel('SHAP Interaction Value')
# plt.ylabel('Frequency')
# plt.show()

import reticulate

interaction_matrix_r = r.interaction_matrix = interaction_matrix
```


```{r,eval=F}

# Pass Python variables to R
imr <- py$interaction_matrix
imr <- as.matrix(imr)
hist(imr)
max(imr)
dim(imr)

colnames(imr)<-colnames(im001)
rownames(imr)<-colnames(im001)


if (cd == "Drought"){
	saveRDS(imr,here("out","imr_d4"))
} else if (cd=="Control"){
	saveRDS(imr,here("out","imr_c4"))
} else {
	stop()
}
```

