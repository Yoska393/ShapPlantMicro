---
title: "7_SHAP_onefactor"
author: "Hayato Yoshioka"
date: "2025-03-03"
output: html_document
---

SHAP for one factor

```{r}
require(here)
source("Script/MyFunctions.R")
library(bnlearn)
library(iml)
require(ranger)
library(ggplot2)
library(igraph)
library(ggraph)
library(dplyr)
library(progress)
library(here)

extract_genus <- function(tax_str) {
  genus_match <- regmatches(tax_str, regexpr("g__[^;]+", tax_str))
  ifelse(length(genus_match) > 0, gsub("g__", "", genus_match), NA)
}


micro_labels_genus <- sapply(cm, extract_genus)

```

```{r}
cd = "Control"

if (cd == "Drought"){
	CD<-"W4"
	Data<-readRDS(here("data/SoyData_Drought2.RDS"))
	imp_total<-readRDS(here("out","imp_RF2_d.RDS"))
} else if (cd=="Control"){
	CD<-"W1"
	Data<-readRDS(here("data/SoyData_Control2.RDS"))
	imp_total<-readRDS(here("out","imp_RF2_c.RDS"))
} else {
	stop()
}
genome<-Data$genome
grm.cd<-Data$grm
met.cd<-Data$met
mic.cd<-Data$mic
mir.cd<-Data$mir
psc19<-Data$pheno
miname<-Data$microname
metname<-Data$metname
cd<-Data$cd

genome<- scale(genome)
met.cd<-scale(met.cd)
mic.cd <- scale(mic.cd)
psc19 <- scale(psc19)


imp_sm<-imp_total[, colSums(imp_total) >= 0.01]

imp.g <- imp_total[, 1:ncol(genome)]
imp.m <- imp_total[, (ncol(genome)+1):(ncol(genome)+ncol(mic.cd))]
imp.met <- imp_total[, (ncol(genome)+ncol(mic.cd)+1):ncol(imp_total)]


g<-genome[, colSums(imp.g) >= 0.001]
m<-mic.cd[, colSums(imp.m) >= 0.001]
met<-met.cd[, colSums(imp.met) >= 0.001]

im001<-cbind(g,m,met)
dim(im001)


g01<-genome[, colSums(imp.g) >= 0.01]
m01<-mic.cd[, colSums(imp.m) >= 0.01]
met01<-met.cd[, colSums(imp.met) >= 0.01]
met02<-met.cd[, colSums(imp.met) >= 0.02]

dim(g01)
dim(m01)
dim(met01)
dim(met02)

data<-cbind(g01,m01,met02,psc19[,c(1,5,8)])
dim(data)


data <- data.frame(data)


```

# SHAP net


```{r}
set.seed(123)

# Combine and scale feature sets
X <- cbind(g01, m01, met01)
X <- scale(X)
X <- data.frame(X)

# Load target variable (phenotype)
Y <- data.frame(psc19)

# Check dimensions (optional)
dim(X)
dim(Y)

# Initialize list to store SHAP results
shap_all <- list()

# Loop over phenotype(s), here using only the first one for simplicity
for (i in 1) {
  cat("Processing phenotype:", colnames(Y)[i], "\n")

  # Create a new dataframe that includes the response variable
  df <- X
  df[[colnames(Y)[i]]] <- Y[[i]]

  # Train a random forest model using ranger
  rf_model <- ranger(
    formula = as.formula(paste(colnames(Y)[i], "~ .")),
    data = df,
    num.trees = 100
  )

  # Create an iml Predictor object
  predictor <- Predictor$new(rf_model, data = X, y = Y[[i]])

  # Add a progress bar to track SHAP computation
  pb <- progress_bar$new(
    format = "  SHAP calculation [:bar] :percent in :elapsed",
    total = nrow(X), clear = FALSE, width = 60
  )

  # Compute SHAP values for each sample
  shap_all_results <- lapply(1:nrow(X), function(j) {
  #shap_all_results <- lapply(1:4, function(j) {
    pb$tick()
    shap <- Shapley$new(predictor, x.interest = X[j, , drop = FALSE])
    shap$results
  })

  # Combine SHAP results into a single dataframe
  shap_df <- do.call(rbind, shap_all_results)
  colnames(shap_df) <- c("feature", "phi", "feature_value")

  # Save SHAP results
  shap_all[[colnames(Y)[i]]] <- shap_df
}

# Extract SHAP results for the first phenotype
shap_df <- shap_all[[colnames(Y)[1]]]
shap_df <- shap_df[, !is.na(colnames(shap_df))]

#saveRDS(shap_df,here("out",paste0("shap_df",cd,".rds")))


```



```{r}

shap_df<- readRDS(here("out",paste0("shap_df",cd,".rds")))

shap_summary_signed <- shap_df %>%
  group_by(feature) %>%
  summarise(mean_phi = mean(phi), .groups = "drop") %>%
  arrange(desc(mean_phi))

# top bottom
shap_top_bottom <- bind_rows(
  shap_summary_signed %>% top_n(10, mean_phi),
  shap_summary_signed %>% top_n(-10, mean_phi)
)

# names
top_bottom_features <- shap_top_bottom$feature

# filter
shap_df_subset <- shap_df %>% filter(feature %in% top_bottom_features)

# --- ① shap summary plot） ---

ggplot(shap_df_subset, aes(x = phi, y = reorder(feature, phi, FUN = median), color = feature_value)) +
  geom_point(alpha = 0.6) +
  scale_color_gradient(low = "blue", high = "red") +
  labs(
    title = paste("Top & Bottom 10 Features for", colnames(Y)[1]),
    x = "SHAP Value",
    y = "Feature"
  ) +
  theme_minimal()

# --- ② SHAP mean（signed） ---

ggplot(shap_top_bottom, aes(x = reorder(feature, mean_phi), y = mean_phi)) +
  geom_col(aes(fill = mean_phi > 0)) +
  scale_fill_manual(values = c("TRUE" = "tomato", "FALSE" = "skyblue")) +
  coord_flip() +
  labs(
    title = paste("Top & Bottom 10 Signed Mean SHAP Values for", colnames(Y)[1]),
    x = "Feature",
    y = "Mean SHAP Value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}

shap_summary_signed <- shap_summary_signed %>%
  mutate(
    group = case_when(
      grepl("^C", feature) ~ "Genome",
      grepl("^B", feature) ~ "Microbiome",
      grepl("^X", feature) ~ "Metabolome",
      TRUE ~ "Other"
    )
  )
#color
node_colors <- c(
  "Genome"     = "#FF6F61",   
  "Microbiome" = "#66B032",   
  "Metabolome" = "orange",    
  "Phenotype"  = "#9B4F96",   
  "Other"      = "#B0B0B0"    
)


ggplot(shap_summary_signed, aes(x = reorder(feature, mean_phi), y = mean_phi, fill = group)) +
  geom_col() +
  scale_fill_manual(values = node_colors) +
  coord_flip() +
  labs(
    title = paste("SHAP Values in", cd),
    x = "Feature",
    y = "Mean SHAP Value",
    fill = "Feature Group"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_blank())


# SHAP mean
shap_summary_signed <- shap_df %>%
  group_by(feature) %>%
  summarise(mean_phi = mean(phi), .groups = "drop")


# Top bottom
shap_top_bottom <- bind_rows(
  shap_summary_signed %>% top_n(10, mean_phi),
  shap_summary_signed %>% top_n(-10, mean_phi)
)


# Grouping
shap_top_bottom <- shap_top_bottom %>%
  mutate(
    group = case_when(
      grepl("^C", feature) ~ "Genome",
      grepl("^B", feature) ~ "Microbiome",
      grepl("^X", feature) ~ "Metabolome",
      TRUE ~ "Other"
    )
  )

# plot
ggplot(shap_top_bottom, aes(x = reorder(feature, mean_phi), y = mean_phi, fill = group)) +
  geom_col() +
  scale_fill_manual(values = node_colors) +
  coord_flip() +
  labs(
    title = paste("SHAP Values in", cd,"(Top & Bottom 10)"),
    x = "Feature",
    y = "Mean SHAP Value",
    fill = "Feature Group"
  ) +
  theme_minimal()

```


with the actual name
```{,fig.width = 10}
get_label <- function(name) {
  label <- case_when(
    str_starts(name, "X") ~ mm[as.numeric(str_remove(name, "X"))],
    str_starts(name, "B") ~ micro_labels_genus[as.numeric(str_remove(name, "B"))],
    TRUE ~ name
  )
  # NA 
  if (!is.na(label)) {
    label <- substr(label, 1, 60)
  }
  return(label)
}


shap_top_bottom <- shap_top_bottom %>%
  mutate(label = sapply(feature, get_label)) %>%
  filter(!is.na(label))  # NA removed


# plot
ggplot(shap_top_bottom, aes(x = reorder(label, mean_phi), y = mean_phi, fill = group)) +
  geom_col() +
  scale_fill_manual(values = node_colors) +
  coord_flip() +
  labs(
    title = paste("SHAP Values in", cd, "(Top & Bottom 10)"),
    x = "Feature",
    y = "Mean SHAP Value",
    fill = "Feature Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),  
    axis.text.y = element_text(size = 10)
  )

```


# abs

```{r,fig.width=10}

cd<-"Control"

shap_df<- readRDS(here("out",paste0("shap_df",cd,".rds")))

shap_summary_signed <- shap_df %>%
  group_by(feature) %>%
  summarise(mean_phi = mean(phi), .groups = "drop") %>%
  arrange(desc(mean_phi))



shap_summary_signed <- shap_summary_signed %>%
  mutate(
    group = case_when(
      grepl("^C", feature) ~ "Genome",
      grepl("^B", feature) ~ "Microbiome",
      grepl("^X", feature) ~ "Metabolome",
      TRUE ~ "Other"
    )
  )


shap_summary_signed <- shap_df %>%
  group_by(feature) %>%
  summarise(mean_phi = mean(abs(phi)), .groups = "drop")


shap_top_bottom <- bind_rows(
  shap_summary_signed %>% top_n(20, mean_phi),
)

shap_top_bottom <- shap_top_bottom %>%
  mutate(
    group = case_when(
      grepl("^C", feature) ~ "Genome",
      grepl("^B", feature) ~ "Microbiome",
      grepl("^X", feature) ~ "Metabolome",
      TRUE ~ "Other"
    )
  )

node_colors <- c(
  "Genome"     = "#FF6F61",   
  "Microbiome" = "#66B032",   
  "Metabolome" = "orange",    
  "Phenotype"  = "#9B4F96",   
  "Other"      = "#B0B0B0"    
)


get_label <- function(name) {
  label <- case_when(
    str_starts(name, "X") ~ mm[as.numeric(str_remove(name, "X"))],
    str_starts(name, "B") ~ micro_labels_genus[as.numeric(str_remove(name, "B"))],
    TRUE ~ name
  )
  if (!is.na(label)) {
    label <- substr(label, 1, 60)
  }
  return(label)
}


shap_top_bottom <- shap_top_bottom %>%
  mutate(label = sapply(feature, get_label)) %>%
  filter(!is.na(label)) 

# plot
ggplot(shap_top_bottom, aes(x = reorder(label, mean_phi), y = mean_phi, fill = group)) +
  geom_col() +
  scale_fill_manual(values = node_colors) +
  coord_flip() +
  labs(
    title = paste("SHAP Values in", cd, "(Top 20)"),
    x = "Feature",
    y = "Mean SHAP Value",
    fill = "Feature Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 16, face = "bold"), 
    axis.text.y = element_text(size = 10)
  )

```
